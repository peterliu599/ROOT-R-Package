---
title: "ROOT Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## Overview

This vignette introduces the main functionality of the ROOT package through simple examples including:

- Using `ROOT()` to visualize final characterized tree from Rashomon Set
- Using `characterizing_underrep()` to visualize underrepresented population in characterization tree
- Specifying a new objective function in `ROOT()` and `characterizing_underrep()` to visualize new output using the same synthetic data.

## We first simulate a target data set and a data set from a randomized clinicial trial (RCT).

```{r}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width  = 6,     # inches (pick a width your layout likes)
  fig.height = 5,     # inches
  fig.retina = 2,     # crisp in HTML; set to 1 if text looks oversized
  dpi        = 150,   # for raster devices
  dev        = "ragg_png"  # consistent sizing & font metrics (needs ragg)
)
library(ROOT)
### Simulate target and RCT data set
make_root_datasets <- function(
    n_rct      = 1500,
    n_target   = 4000,
    p          = 6,      # number of continuous covariates
    rho        = 0.35,   # common correlation between covariates
    mean_shift = 0.45,   # shift of target means vs. RCT
    seed       = 123
) {
  stopifnot(p >= 1)
  set.seed(seed)

  # (1) helpers
  Sigma <- matrix(rho, p, p); diag(Sigma) <- 1

  # fast log N(x | mu, Sigma) without extra deps
  logdmvnorm <- function(X, mu, Sigma) {
    X <- as.matrix(X)
    p <- ncol(X)
    R <- chol(Sigma)
    z <- t(backsolve(R, t(X) - mu, transpose = TRUE))
    quad <- rowSums(z * z)
    const <- -0.5 * p * log(2 * pi) - sum(log(diag(R)))
    const - 0.5 * quad
  }

  # (2) generate covariates (ALL continuous)
  mu_rct <- rep(0, p)
  mu_tgt <- mu_rct + mean_shift

  X_rct <- MASS::mvrnorm(n_rct, mu = mu_rct, Sigma = Sigma)
  X_tgt <- MASS::mvrnorm(n_target, mu = mu_tgt, Sigma = Sigma)
  colnames(X_rct) <- colnames(X_tgt) <- paste0("X", seq_len(p))

  # (3) treatment assignment in the RCT
  beta_t <- seq(0.8, 0.2, length.out = p)        # weights
  lin_t  <- -0.2 + as.vector(X_rct %*% beta_t)
  pr_t   <- 1 / (1 + exp(-lin_t))
  Tr     <- rbinom(n_rct, 1, pr_t)

  # (4) outcome in the RCT (heterogeneous treatment effect)
  beta_y <- seq(0.6, 0.1, length.out = p)
  theta  <- seq(0.5, 0.1, length.out = p) * 0.5
  tau0   <- 0.4
  b0     <- -0.3
  lin_y  <- b0 + as.vector(X_rct %*% beta_y) + Tr * (tau0 + as.vector(X_rct %*% theta))
  pr_y   <- 1 / (1 + exp(-lin_y))
  Y      <- rbinom(n_rct, 1, pr_y)

  # (5) rarity score lX for target rows (under RCT X distribution)
  logp_target <- logdmvnorm(X_tgt, mu = mu_rct, Sigma = Sigma)
  lX          <- as.numeric(scale(logp_target))  # mean 0, sd 1

  # (6) assemble outputs
  DataRCT    <- data.frame(X_rct, Tr = Tr, Y = Y, check.names = FALSE)
  DataTarget <- data.frame(X_tgt, lX = lX, check.names = FALSE)
  cov_names  <- colnames(X_rct)

  # ROOT-ready combined frame: S=1 for RCT, S=0 for Target; Y/Tr NA on Target
  D_root <- rbind(
    data.frame(X_rct, Yobs = Y, Tr = Tr, S = 1L, check.names = FALSE),
    data.frame(X_tgt, Yobs = NA_real_, Tr = NA_integer_, S = 0L, check.names = FALSE)
  )
  rownames(D_root) <- NULL

  list(
    DataRCT              = DataRCT,
    DataTarget           = DataTarget,
    covariate_DataRCT    = cov_names,
    covariate_DataTarget = cov_names,
    treatment_DataRCT    = "Tr",
    outcome_DataRCT      = "Y",
    D_root               = D_root
  )
}

### Generate data
gen <- make_root_datasets(
  n_rct = 1500, n_target = 4000, p = 6, rho = 0.35, mean_shift = 0.45, seed = 123
)
```

## Visualize final characterized tree from Rashomon Set

```{r}
outputROOT <- ROOT(
  data     = gen$D_root,
  outcome  = "Yobs",
  treatment= "Tr",
  sample   = "S",
  leaf_proba = 0.25,
  seed       = 3,
  num_trees  = 50,
  vote_threshold = 2/3,
  explore_proba  = 0.05,
  feature_est    = "Ridge",
  top_k_trees    = FALSE,
  cutoff         = "baseline",
  verbose  = TRUE,)
summary(outputROOT)
plot(outputROOT)
```

## Visualize underrepresented population in characterization tree

```{r}
outputUnderrep <- characterizing_underrep(
  DataRCT               = gen$DataRCT,
  covariateColName_RCT  = gen$covariate_DataRCT,
  trtColName_RCT        = gen$treatment_DataRCT,
  outcomeColName_RCT    = gen$outcome_DataRCT,
  DataTarget            = gen$DataTarget,
  covariateColName_TargetData  = gen$covariate_DataTarget,
  num_trees             = 50,
  seed                  = 3,
  verbose               = TRUE
)
summary(outputUnderrep)
plot(outputUnderrep)
```

## Using a new global objective/loss function and the same data sets, visualize final characterized tree from Rashomon Set

```{r}
# Factory returning an objective_fn(D) -> scalar
objective_variance_plus_drop <- function(lambda = 0.05) {
  force(lambda)
  function(D) {
    wsum <- sum(D$w)
    if (wsum <= 0) return(Inf)                           # no kept units â†’ invalid
    # default variance proxy
    var_term <- sqrt(sum(D$vsq * D$w) / (wsum^2))
    # penalize dropping too many (1 - mean(w) is drop rate)
    pen <- lambda * (1 - mean(D$w))
    var_term + pen
  }
}
obj <- objective_variance_plus_drop(lambda = 0.05)

### Run ROOT directly using an arbitrary data with a user-specified global objective/loss function
outputROOT2 <- ROOT(
  data     = gen$D_root,
  outcome  = "Yobs",
  treatment= "Tr",
  sample   = "S",
  leaf_proba = 0.25,
  seed       = 3,
  num_trees  = 50,
  vote_threshold = 2/3,
  explore_proba  = 0.05,
  feature_est    = "Ridge",
  top_k_trees    = FALSE,
  verbose  = TRUE,
  cutoff         = "baseline",
  global_objective_fn = obj,
)
summary(outputROOT2)
plot(outputROOT2)
```


## Using a new global objective/loss function and the same data sets, visualize underrepresented population in characterization tree

```{r}
### Run characterizing_underrep function with a user-specified loss function
outputUnderrep2 <- characterizing_underrep(
  DataRCT               = gen$DataRCT,
  covariateColName_RCT  = gen$covariate_DataRCT,
  trtColName_RCT        = gen$treatment_DataRCT,
  outcomeColName_RCT    = gen$outcome_DataRCT,
  DataTarget            = gen$DataTarget,
  covariateColName_TargetData  = gen$covariate_DataTarget,
  num_trees             = 50,
  seed                  = 3,
  verbose               = TRUE,
  global_objective_fn = obj,
)
summary(outputUnderrep2)
plot(outputUnderrep2)
```

